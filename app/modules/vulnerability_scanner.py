import nmap
from urllib.parse import urlparse
import socket
import logging

class VulnerabilityScanner:
    def __init__(self):
        self.scanner = nmap.PortScanner()
        self.logger = logging.getLogger(__name__)
    
    def _get_ip_from_url(self, url):
        """Extract IP from URL or domain"""
        parsed = urlparse(url)
        domain = parsed.netloc or parsed.path.split('/')[0]  # Handle cases without http://
        try:
            # Remove port number if present
            domain = domain.split(':')[0]
            return socket.gethostbyname(domain)
        except socket.gaierror as e:
            self.logger.error(f"DNS resolution failed for {domain}: {e}")
            return None

    def scan_target(self, target):
        """Perform vulnerability scan on target"""
        results = []
        
        # Clean up target input
        target = target.strip().lower()
        if not target:
            return "Error: No target specified"
            
        # Extract IP from URL if needed
        if target.startswith(('http://', 'https://')):
            target_ip = self._get_ip_from_url(target)
            if not target_ip:
                return f"Error: Could not resolve hostname '{target}'"
            results.append(f"Resolved {target} to {target_ip}")
        else:
            target_ip = target
            
        try:
            # Use TCP connect scan (-sT) instead of SYN scan (-sS)
            # Also use version detection (-sV) but with light intensity (--version-intensity 2)
            scan_args = '-sT -sV --version-intensity 2 -Pn'
            results.append(f"Starting scan on {target_ip}...")
            
            scan_results = self.scanner.scan(target_ip, '21-25,80,443,8080,8443', arguments=scan_args)
            
            if not scan_results.get('scan'):
                return f"No results: Host {target_ip} appears to be down or blocking our scans"
                
            host_data = scan_results['scan'].get(target_ip, {})
            
            # Format results
            results.append(f"\nScan report for {target} ({target_ip})")
            results.append("=" * 50)
            results.append("PORT     STATE  SERVICE    VERSION")
            results.append("-" * 50)
            
            tcp_data = host_data.get('tcp', {})
            if not tcp_data:
                results.append("No open ports found")
            else:
                for port, data in tcp_data.items():
                    state = data.get('state', 'unknown')
                    service = data.get('name', 'unknown')
                    version = data.get('version', '')
                    product = data.get('product', '')
                    version_info = f"{product} {version}".strip()
                    
                    results.append(f"{port:<8} {state:<6} {service:<10} {version_info}")
                    
                    # Add educational security notes
                    if state == 'open':
                        if service == 'ftp':
                            results.append("    ! Check for anonymous FTP access")
                        elif service == 'ssh':
                            results.append("    ! Verify SSH version for CVEs")
                        elif service in ['http', 'https']:
                            results.append("    ! Check for common web vulnerabilities")
                
            return "\n".join(results)
            
        except nmap.PortScannerError as e:
            return f"Scan Error: {str(e)}"
        except Exception as e:
            self.logger.error(f"Unexpected error during scan: {str(e)}")
            return f"Error: Scan failed unexpectedly. Check target and try again."